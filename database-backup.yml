---
- name: Database backup
  hosts: test-server
  remote_user: root
  
  tasks:
  - name: Create backup Directory
    file:
      path: /var/www/html/databases/
      state: directory

  - name: Dump Databases
    mysql_db:
      state: dump
      name: all
      target: /var/www/html/databases/{{ ansible_date_time.date }}.sql
      login_user: root
      login_password: password

  - name: Archive Database dump
    become: yes
    become_user: root
    archive:
      path: /var/www/html/databases/*.sql
      dest: /var/www/html/databases/{{ ansible_date_time.date }}.tar.gz
      remove: yes

  - name: Fetch Backup from the server
    become: yes
    become_user: root
    synchronize:
      mode: pull
      src: "/var/www/html/databases/"
      dest: "~/backup/"
      rsync_opts: "--remove-source-files"

